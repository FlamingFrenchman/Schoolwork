# Makefile, Author: Robert Bergeron, ID: rbergero

# Extremely picky compiler options
WARN = -Wall -Wextra -Werror -Wpedantic -Wshadow -Wold-style-cast
# full gcc exec command
CPP  = g++ -g -O0 -std=gnu++17
CPPWARN = ${CPP} ${WARN} -fdiagnostics-color=never
CPPYY = ${CPP} -Wno-sign-compare -Wno-register
DEPCPP = g++ -std=gnu++17 -MM ${WARN}
MKFILE = Makefile
DEPFILE = ${MKFILE}.dep
GMAKE = ${MAKE} --no-print-directory
# name of the compiled executable
EXECNAME = oc
# .cpp source files
CPPSRC = main.cpp auxlib.cpp string_set.cpp astree.cpp lyutils.cpp
# .h header files
HEADERS = auxlib.h string_set.h astree.h lyutils.h
# .gch header somethings?
GCH = auxlib.h.gch string_set.h.gch lyutils.h.gch astree.h.gch
# .o object files
OBJECTS = main.o auxlib.o string_set.o yylex.o yyparse.o lyutils.o astree.o
# files generated by ex. flex and bison
GENS = yylex.cpp yyparse.cpp
HEADERGENS = yyparse.h

all : ${DEPFILE} ${EXECNAME}

${EXECNAME} : ${OBJECTS}
	${CPP} -o oc ${OBJECTS}

yylex.o : yylex.cpp
	${CPPYY} -c $<

yyparse.o : yyparse.cpp
	${CPPYY} -c $<

%.o : %.cpp
	${CPP} -c $< ${HEADERS}

yylex.cpp : scanner.l
	flex --outfile=yylex.cpp scanner.l

yyparse.cpp yyparse.h : parser.y
	bison --defines=yyparse.h --output=yyparse.cpp parser.y

rmtest :
	rm -f *.oc *.str *.err *.out *.tok

clean :
	rm -f ${OBJECTS} ${GCH} ${DEPFILE}

ci :
	git add ${HEADERS} ${CPPSRC} ${MKFILE} scanner.l parser.y

spotless : clean
	rm -f ${EXECNAME}

deps : ${CPPSRC}
	${DEPCPP} ${HEADERS} ${CPPSRC} ${GENS} ${HEADERGENS} ${MKFILE} >> ${DEPFILE}

${DEPFILE} :
	@ touch ${DEPFILE}
	${GMAKE} deps
